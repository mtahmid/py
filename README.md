# py

git import io
import os
import uuid

import pytest
from autobot.webdrivers.local_web_driver import LocalWebDriverChrome, \
    LocalWebDriverFirefox, LocalWebDriverSafari
from autobot.webdrivers.remote_web_driver import RemoteWebDriver
from selenium.webdriver.chrome.options import Options
from src.testproject.sdk.drivers import webdriver
from selenium.webdriver.firefox.options import Options as FirefoxOptions
from tests.ui_tests.utils.get_local_secrets import extractSecrets, hasSecrets
from tests.ui_tests.utils.test_session import TestSession

file_path = os.getcwd()

opt = Options()
opt.add_argument("--disable-infobars")
opt.add_argument("window-size=1920,1080")
opt.add_experimental_option("prefs", {
    "profile.default_content_setting_values.media_stream_mic": 1,
    "profile.default_content_setting_values.media_stream_camera": 1,
    "profile.default_content_setting_values.geolocation": 1,
    "profile.default_content_setting_values.notifications": 1,
    "download.default_directory": file_path + '/downloads',
})

chrome_headless_opt = Options()
chrome_headless_opt.add_argument("window-size=1920,1080")
chrome_headless_opt.add_argument("--headless")

firefox_headless_opt = FirefoxOptions()
firefox_headless_opt.headless = True

remote_opt = Options()
remote_opt.add_argument("--disable-infobars")
remote_opt.add_argument("start-maximized")
remote_opt.add_argument("--disable-extensions")
remote_opt.add_argument("--use-fake-device-for-media-stream")
remote_opt.add_argument("--use-fake-ui-for-media-stream")
remote_opt.add_experimental_option("prefs", {
    "profile.default_content_setting_values.media_stream_mic": 1,
    "profile.default_content_setting_values.media_stream_camera": 1,
    "profile.default_content_setting_values.geolocation": 1,
    "profile.default_content_setting_values.notifications": 1
})

browserstack_url = os.environ.get('BROWSERSTACK_URL')
browser = os.environ.get('BROWSER')
browser_version = os.environ.get('BROWSER_VERSION')
operating_system = os.environ.get('OS')
os_version = os.environ.get('OS_VERSION')
test_type = os.environ.get('UI_TEST_TYPE', '')
resolution = os.environ.get('RESOLUTION')


@pytest.hookimpl(tryfirst=True, hookwrapper=True)
def pytest_runtest_makereport(item, call):
    # execute all other hooks to obtain the report object
    outcome = yield
    rep = outcome.get_result()

    # set a report attribute for each phase of a call, which can
    # be "setup", "call", "teardown"

    setattr(item, "rep_" + rep.when, rep)


@pytest.fixture(scope="function")
def secretFixture(request):
    """
    Read values from secrets csv that gets generated by gopher.
    :param request:
    :return: Dictionary object with secrets
    """
    ts = TestSession()
    secrets = {}

    if hasSecrets():
        file_path = os.getcwd() + '/secrets/in-use/secrets.csv'

        with io.open(file_path, newline='') as csvfile:
            secrets = extractSecrets(csvfile)
        ts.set_secrets(secrets)
        return ts


@pytest.fixture(scope="function")
def driverFixture(request, secretFixture):
    """
    Fixture for running driver on zalenium grid with input from
    secretFixture csv file.
    :param secretFixture: Values read from secrets fixture csv file
    :return:
    """
    ts = secretFixture
    build = uuid.uuid4().hex
    current_test = os.environ['PYTEST_CURRENT_TEST'].split('(')[0]
    test_case = current_test.split('/')[1] + ': ' + current_test.split('::')[1]
    if test_type == 'local':
        driver = LocalWebDriverChrome(
            desired_capabilities={
                'browserName': ts.browser,
                'platform': 'mac',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build
            },
            options=opt
        )
    elif test_type == 'browserstack':
        driver = RemoteWebDriver(
            command_executor=browserstack_url,
            desired_capabilities={
                'browserName': browser,
                'browser_version': browser_version,
                'os': operating_system,
                'os_version': os_version,
                'resolution': resolution,
                'name': test_case,
                'browserstack.local': 'true',
                'browserstack.debug': 'true',
                'browserstack.networkLogs': 'true',
                'browserstack.console': 'errors',
            }
        )
    else:
        driver = RemoteWebDriver(
            command_executor='https://zalenium.sandbox.pymetrics.com/wd/hub',
            desired_capabilities={
                'browserName': 'chrome',
                'platform': 'linux',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build,
                'name': test_case,
            },
            options=remote_opt
        )
    driver.maximize_window()
    yield driver
    if request.node.rep_setup.failed:
        print("setting up a test failed!", request.node.nodeid)
    elif request.node.rep_setup.passed:
        if request.node.rep_call.passed:
            driver.add_cookie({"name": "zaleniumTestPassed", "value": "true"})
        elif request.node.rep_call.failed:
            driver.add_cookie({"name": "zaleniumTestPassed", "value": "false"})
    driver.quit()


@pytest.fixture(scope="function")
def driver(request):
    """
    Fixture for running driver on zalenium grid without input from
    secretFixture csv file.
    :param secretFixture: Values read from secrets fixture csv file
    :return:
    """
    ts = TestSession()

    current_test = os.environ['PYTEST_CURRENT_TEST'].split('(')[0]
    test_case = current_test.split('/')[1] + ': ' + current_test.split('::')[1]
    test_type = os.environ.get('UI_TEST_TYPE', '').lower()
    build = uuid.uuid4().hex
    if test_type == 'firefox':
        driver = LocalWebDriverFirefox(
            desired_capabilities={
                'browserName': 'firefox',
                'marionette': True,
                'platform': 'mac',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build
            }
        )
    elif test_type == 'firefox-headless':
        driver = LocalWebDriverFirefox(
            options=firefox_headless_opt,
            desired_capabilities={
                'browserName': 'firefox',
                'marionette': True,
                'platform': 'mac',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build
            }
        )
    elif test_type == 'chrome':
        driver = LocalWebDriverChrome(
            chrome_options=opt,
            desired_capabilities={
                'browserName': 'chrome',
                'platform': 'mac',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build
            }
        )
    elif test_type == 'chrome-headless':
        driver = LocalWebDriverChrome(
            chrome_options=chrome_headless_opt,
            desired_capabilities={
                'browserName': 'chrome',
                'platform': 'mac',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build
            }
        )
    elif test_type == 'safari':
        driver = LocalWebDriverSafari(
            desired_capabilities={
                'browserName': 'safari',
                'platform': 'mac',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build
            }
        )
    elif test_type == 'edge-project':
        driver = webdriver.Edge(
            token='468OcpX1RFUav4PatOqUqsLpQSE1vEAaxr-ocqaJHE41',
            desired_capabilities={
                'browserName': 'MicrosoftEdge',
            }
        )
    elif test_type == 'safari-project':
        driver = webdriver.Safari(
            token='468OcpX1RFUav4PatOqUqsLpQSE1vEAaxr-ocqaJHE41',
        )
    else:
        driver = RemoteWebDriver(

            # todo: Replace with kubernetes url eventaully
            # Local command_executor=`http://127.0.0.1`
            command_executor='https://zalenium.sandbox.pymetrics.com/wd/hub',
            desired_capabilities={
                'browserName': 'chrome',
                'platform': 'linux',
                'javascriptEnabled': True,
                'idleTimeout': 180,
                'pageLoadStrategy': 'none',
                'build': build,
                'name': test_case,
            },
            options=remote_opt
        )
    driver.maximize_window()
    yield driver
    if request.node.rep_setup.failed:
        print("setting up a test failed!", request.node.nodeid)
    elif request.node.rep_setup.passed:
        if request.node.rep_call.passed:
            driver.add_cookie({"name": "zaleniumTestPassed", "value": "true"})
        elif request.node.rep_call.failed:
            driver.add_cookie({"name": "zaleniumTestPassed", "value": "false"})
    driver.quit()
